name: Integration & Compliance Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  integration-tests:
    name: Full Integration Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: content_crew_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version
      
      - name: Install system dependencies
        run: |
          sudo apt-get install -y \
            libpq-dev \
            build-essential
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout httpx
      
      - name: Wait for services
        run: |
          echo "Waiting for Postgres..."
          timeout 30 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'
          
          echo "Waiting for Redis..."
          timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'
          
          echo "✓ All services ready"
      
      - name: Set up test environment
        run: |
          cp .env.example .env.test
          cat >> .env.test <<EOF
          DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/content_crew_test
          REDIS_URL=redis://localhost:6379/0
          SECRET_KEY=test-secret-key-for-ci-only
          ENABLE_VIDEO_RENDERING=false
          ENABLE_TTS=false
          OLLAMA_BASE_URL=http://localhost:11434
          STRIPE_SECRET_KEY=sk_test_fake
          PAYSTACK_SECRET_KEY=sk_test_fake
          EOF
      
      - name: Run database migrations
        run: |
          export $(cat .env.test | xargs)
          alembic upgrade head
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Run integration tests
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/ \
            --timeout=300 \
            -v \
            --tb=short \
            --maxfail=3
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test GDPR flows
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/test_security_regression.py::test_user_export \
                 tests/integration/test_security_regression.py::test_user_delete \
                 -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test health endpoints
        run: |
          export $(cat .env.test | xargs)
          pytest tests/test_health_check.py -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test metrics emission
        run: |
          export $(cat .env.test | xargs)
          pytest tests/test_metrics.py -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Verify Postgres-only (no SQLite)
        run: |
          if grep -r "sqlite" src/ --include="*.py" | grep -v "# " | grep -v test; then
            echo "ERROR: Found SQLite references in production code"
            exit 1
          fi
          echo "✓ Postgres-only verified"
      
      - name: Verify Redis usage
        run: |
          export $(cat .env.test | xargs)
          python -c "
          import redis
          r = redis.from_url('redis://localhost:6379/0')
          r.ping()
          print('✓ Redis operational')
          "
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            pytest-report.xml
            .coverage
        if: always()

  compliance-tests:
    name: Compliance & Security Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: content_crew_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Set up test environment
        run: |
          cp .env.example .env.test
          cat >> .env.test <<EOF
          DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/content_crew_test
          REDIS_URL=redis://localhost:6379/0
          SECRET_KEY=test-secret-key-for-ci-only
          EOF
      
      - name: Run migrations
        run: |
          export $(cat .env.test | xargs)
          alembic upgrade head
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test GDPR export/delete
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/test_security_regression.py::test_user_export \
                 tests/integration/test_security_regression.py::test_user_delete \
                 tests/integration/test_security_regression.py::test_hard_delete_job \
                 -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test password policy
        run: |
          export $(cat .env.test | xargs)
          pytest tests/test_password_validator.py -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test rate limiting
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/test_security_regression.py::test_login_rate_limit -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test logging security
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/test_security_regression.py::test_logging_redaction -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test retention cleanup
        run: |
          export $(cat .env.test | xargs)
          pytest tests/test_artifact_retention.py -v
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Test moderation blocking
        run: |
          export $(cat .env.test | xargs)
          pytest tests/integration/test_security_regression.py::test_prompt_injection_block -v
        env:
          PYTHONPATH: ${{ github.workspace }}

  integration-summary:
    name: Integration Tests Summary
    runs-on: ubuntu-latest
    needs: [integration-tests, compliance-tests]
    if: always()
    steps:
      - name: Check Integration Results
        run: |
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          
          if [ "${{ needs.compliance-tests.result }}" != "success" ]; then
            echo "❌ Compliance tests failed"
            exit 1
          fi
          
          echo "✅ All integration and compliance tests passed!"

